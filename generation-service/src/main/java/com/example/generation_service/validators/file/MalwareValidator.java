package com.example.generation_service.validators.file;

import com.example.generation_service.converters.MultipartFileConverter;
import com.example.generation_service.models.user.UserFeature;
import com.example.generation_service.models.enums.UploadStatus;
import com.example.generation_service.services.MalwareService;
import com.example.generation_service.services.user.UserFeatureService;
import com.example.generation_service.validators.file.dto.FileValidationDto;
import lombok.RequiredArgsConstructor;
import org.dmnvch.bytescale.model.enumeration.MalwareCheckStatus;
import org.springframework.core.annotation.Order;
import org.springframework.stereotype.Component;

import java.io.IOException;
import java.util.Optional;

@Component
@RequiredArgsConstructor
@Order(4)
public class MalwareValidator implements FileValidator {

    private final MultipartFileConverter converter;
    private final MalwareService malwareService;
    private final UserFeatureService userFeatureService;

    @Override
    public FileValidationDto validate(FileValidationDto dto) {
        final boolean featureEnabled = Optional.ofNullable(dto.getUserId())
                .map(userFeatureService::getUserFeatures)
                .map(UserFeature::getAntivirusEnabled)
                .orElse(true);

        UploadStatus uploadStatus = UploadStatus.SUCCESS;
        if (featureEnabled) {
            try {
                final MalwareCheckStatus result = malwareService.isInfected(
                        converter.convertToMultipartBodyPart(dto.getFile()),
                        dto.getFile().getOriginalFilename()
                );
                uploadStatus = mapStatus(result);
            } catch (IOException e) {
                throw new RuntimeException("Error during malware check", e);
            }
        }

        dto.setUploadStatus(uploadStatus);
        return dto;
    }

    private UploadStatus mapStatus(final MalwareCheckStatus status) {
        if (status == null) {
            return UploadStatus.FAILED;
        }

        return switch (status) {
            case HEALTHY -> UploadStatus.SUCCESS;
            case INFECTED -> UploadStatus.MALWARE;
            default -> UploadStatus.FAILED;
        };
    }
}
